# ä½¿ç”¨å®˜æ–¹è½»é‡çº§ Python 3.10 é•œåƒ
# FROM python:3.10-slim
# 1. åŸºç¡€é•œåƒï¼šæ˜ç¡®é”å®šä½¿ç”¨ Debian 12 (Bookworm) ç¨³å®šç‰ˆï¼Œé¿å…ä½¿ç”¨ Trixie (Testing)
FROM docker.m.daocloud.io/library/python:3.10-slim-bookworm

# 1. è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# =========== ğŸ‘‡ æ–°å¢/ä¿®æ”¹è¿™éƒ¨åˆ† ğŸ‘‡ ===========
# 1. æ›¿æ¢ç³»ç»Ÿæºä¸ºæ¸…åæº (é’ˆå¯¹ Debian Bookworm)ï¼Œå¦åˆ™ä¸­é—´è¦è®¿é—®å¤–ç½‘
# è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œèƒ½æŠŠ 4000ç§’ ç¼©çŸ­åˆ° 40ç§’
# RUN sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list.d/debian.sources && \
#     sed -i 's/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list.d/debian.sources

# 2. å®‰è£…ç³»ç»Ÿçº§ä¾èµ– (OpenCV, PaddleOCR, PDFå¤„ç†å¿…éœ€)
# libgl1/libglib2.0 -> OpenCV
# poppler-utils -> pdf2image
# libgomp1 -> PaddlePaddle å¤šçº¿ç¨‹
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    poppler-utils \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# 3. å¤åˆ¶ä¾èµ–æ¸…å•å¹¶å®‰è£…
# ä½¿ç”¨æ¸…åæºåŠ é€Ÿä¸‹è½½
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 4. å¤åˆ¶ä¸šåŠ¡ä»£ç 
COPY app ./app
COPY .env .

# 5. æš´éœ²ç«¯å£
EXPOSE 8000

# 6. å¯åŠ¨å‘½ä»¤ (ç”Ÿäº§æ¨¡å¼)
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]